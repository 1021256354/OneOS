if OneOS then OneOS.ToolBarColour=colours.grey;OneOS.ToolBarTextColour=colours.white end;colours.transparent=-1;colors.transparent=-1;local a,b=term.getSize()local d=function(g,i)local j=10^i or 0;return math.floor(g*j+0.5)/j end;Clipboard={Content=nil,Type=nil,IsCut=false,Empty=function()Clipboard.Content=nil;Clipboard.Type=nil;Clipboard.IsCut=false end,isEmpty=function()return Clipboard.Content==nil end,Copy=function(k,q)Clipboard.Content=k;Clipboard.Type=q or'generic'Clipboard.IsCut=false end,Cut=function(k,q)Clipboard.Content=k;Clipboard.Type=q or'generic'Clipboard.IsCut=true end,Paste=function()local c,t=Clipboard.Content,Clipboard.Type;if Clipboard.IsCut then Clipboard.Empty()end;return c,t end}if OneOS and OneOS.Clipboard then Clipboard=OneOS.Clipboard end;Drawing={Screen={Width=a,Height=b},DrawCharacters=function(x,y,u,w,A)Drawing.WriteStringToBuffer(x,y,u,w,A)end,DrawBlankArea=function(x,y,B,h,C)Drawing.DrawArea(x,y,B,h," ",1,C)end,DrawArea=function(x,y,B,h,D,w,A)if B<0 then B=B*-1 elseif B==0 then B=1 end;for E=1,B do local F=x+E-1;for G=1,h do local H=y+G-1;Drawing.WriteToBuffer(F,H,D,w,A)end end end,DrawImage=function(I,J,K,B,h)if K then for y=1,h do if not K[y]then break end;for x=1,B do if not K[y][x]then break end;local A=K[y][x]local w=K.textcol[y][x]or colours.white;local char=K.text[y][x]Drawing.WriteToBuffer(x+I-1,y+J-1,char,w,A)end end elseif B and h then Drawing.DrawBlankArea(x,y,B,h,colours.green)end end,LoadImage=function(L)local M={text={},textcol={}}local N=fs;if OneOS then N=OneOS.FS end;if N.exists(L)then local O=io.open;if OneOS then O=OneOS.IO.open end;local P=O(L,"r")local Q=P:read()local g=1;while Q do table.insert(M,g,{})table.insert(M.text,g,{})table.insert(M.textcol,g,{})local R=1;local S,T=false,false;local U,V=nil,nil;for W=1,#Q do local Z=string.sub(Q,W,W)if Z:byte()==30 then S=true elseif Z:byte()==31 then T=true elseif S then U=Drawing.GetColour(Z)S=false elseif T then V=Drawing.GetColour(Z)T=false else if Z~=" "and V==nil then V=colours.white end;M[g][R]=U;M.textcol[g][R]=V;M.text[g][R]=Z;R=R+1 end end;g=g+1;Q=P:read()end;P:close()end;return M end,DrawCharactersCenter=function(x,y,B,h,u,w,A)B=B or Drawing.Screen.Width;h=h or Drawing.Screen.Height;x=x or 0;y=y or 0;x=math.ceil((B-#u)/2)+x;y=math.floor(h/2)+y;Drawing.DrawCharacters(x,y,u,w,A)end,GetColour=function(_)if _==' 'then return colours.transparent end;local a0=tonumber(_,16)if not a0 then return nil end;a0=math.pow(2,a0)return a0 end,Clear=function(a1)a1=a1 or colours.black;Drawing.ClearBuffer()Drawing.DrawBlankArea(1,1,Drawing.Screen.Width,Drawing.Screen.Height,a1)end,Buffer={},BackBuffer={},DrawBuffer=function()for y,a2 in pairs(Drawing.Buffer)do for x,a3 in pairs(a2)do local a4=true;local a5=true;if Drawing.BackBuffer[y]==nil or Drawing.BackBuffer[y][x]==nil or#Drawing.BackBuffer[y][x]~=3 then a5=false end;if a5 and Drawing.BackBuffer[y][x][1]==Drawing.Buffer[y][x][1]and Drawing.BackBuffer[y][x][2]==Drawing.Buffer[y][x][2]and Drawing.BackBuffer[y][x][3]==Drawing.Buffer[y][x][3]then a4=false end;if a4 then term.setBackgroundColour(a3[3])term.setTextColour(a3[2])term.setCursorPos(x,y)term.write(a3[1])end end end;Drawing.BackBuffer=Drawing.Buffer;Drawing.Buffer={}term.setCursorPos(1,1)end,ClearBuffer=function()Drawing.Buffer={}end,WriteStringToBuffer=function(x,y,u,w,A)for W=1,#u do local D=u:sub(W,W)Drawing.WriteToBuffer(x+W-1,y,D,w,A)end end,WriteToBuffer=function(x,y,D,w,A)x=d(x)y=d(y)if A==colours.transparent then Drawing.Buffer[y]=Drawing.Buffer[y]or{}Drawing.Buffer[y][x]=Drawing.Buffer[y][x]or{"",colours.white,colours.black}Drawing.Buffer[y][x][1]=D;Drawing.Buffer[y][x][2]=w else Drawing.Buffer[y]=Drawing.Buffer[y]or{}Drawing.Buffer[y][x]={D,w,A}end end}UIColours={Toolbar=colours.grey,ToolbarText=colours.lightGrey,ToolbarSelected=colours.lightBlue,ControlText=colours.white,ToolbarItemTitle=colours.black,Background=colours.lightGrey,MenuBackground=colours.white,MenuText=colours.black,MenuSeparatorText=colours.grey,MenuDisabledText=colours.lightGrey,Shadow=colours.grey,TransparentBackgroundOne=colours.white,TransparentBackgroundTwo=colours.lightGrey,MenuBarActive=colours.white}Current={Artboard=nil,Layer=nil,Tool=nil,ToolSize=1,Toolbar=nil,Colour=colours.lightBlue,Menu=nil,MenuBar=nil,Window=nil,Input=nil,CursorPos={1,1},CursorColour=colours.black,InterfaceVisible=true,Selection={},SelectionDrawTimer=nil,HandDragStart={},Modified=false}local a6=false;function PrintCentered(text,y)local B,h=term.getSize()x=math.ceil(math.ceil(B/2-#text/2),0)+1;term.setCursorPos(x,y)print(text)end;function DoVanillaClose()term.setBackgroundColour(colours.black)term.setTextColour(colours.white)term.clear()term.setCursorPos(1,1)PrintCentered("Thanks for using Sketch!",Drawing.Screen.Height/2-1)term.setTextColour(colours.lightGrey)PrintCentered("Photoshop Inspired Image Editor for ComputerCraft",Drawing.Screen.Height/2)term.setTextColour(colours.white)PrintCentered("(c) oeed 2013 - 2014",Drawing.Screen.Height/2+3)term.setCursorPos(1,Drawing.Screen.Height)error('',0)end;function Close()if a6 or not Current.Artboard or not Current.Modified then if not OneOS then DoVanillaClose()end;return true else local a=ButtonDialougeWindow:Initialise('Quit Sketch?','You have unsaved changes, do you want to quit anyway?','Quit','Cancel',function(a7,a8)if a8 then if OneOS then OneOS.Close(true)else DoVanillaClose()end end;a7:Close()Draw()end):Show()os.queueEvent('mouse_click',1,a.X,a.Y)return false end end;if OneOS then OneOS.CanClose=function()return Close()end end;Lists={Artboards={},Interface={Toolbars={}}}Events={}function SetColour(C)Current.Colour=C;Draw()end;function SetTool(a9)if a9 and a9.Select and a9:Select()then Current.Input=nil;Current.Tool=a9;return true end;return false end;function GetAbsolutePosition(aa)local ac=aa;local W=0;local x=1;local y=1;while true do x=x+ac.X-1;y=y+ac.Y-1;if not ac.Parent then return{X=x,Y=y}end;ac=ac.Parent;if W>32 then return{X=1,Y=1}end;W=W+1 end end;Pixel={TextColour=colours.black,BackgroundColour=colours.white,Character=" ",Layer=nil,Draw=function(ad,x,y)if ad.BackgroundColour~=colours.transparent or ad.Character~=' 'then Drawing.WriteToBuffer(ad.Layer.Artboard.X+x-1,ad.Layer.Artboard.Y+y-1,ad.Character,ad.TextColour,ad.BackgroundColour)end end,Initialise=function(ad,w,ae,D,af)local new={}setmetatable(new,{__index=ad})new.TextColour=w or ad.TextColour;new.BackgroundColour=ae or ad.BackgroundColour;new.Character=D or ad.Character;new.Layer=af;return new end,Set=function(ad,w,ae,D)ad.TextColour=w or ad.TextColour;ad.BackgroundColour=ae or ad.BackgroundColour;ad.Character=D or ad.Character end}Layer={Name="",Pixels={},Artboard=nil,BackgroundColour=colours.white,Visible=true,Index=1,Draw=function(ad)if ad.Visible then for x=1,ad.Artboard.Width do for y=1,ad.Artboard.Height do ad.Pixels[x][y]:Draw(x,y)end end end end,Remove=function(ad)for W,v in ipairs(ad.Artboard.Layers)do if v==Current.Layer then Current.Artboard.Layers[W]=nil;Current.Layer=Current.Artboard.Layers[1]ModuleNamed('Layers'):Update()end end end,Initialise=function(ad,ag,ae,ah,ai,aj)local new={}setmetatable(new,{__index=ad})new.Name=ag;new.Pixels={}new.BackgroundColour=ae;new.Artboard=ah;new.Index=ai or#ah.Layers+1;if not aj then new:MakeAllBlankPixels()else new:MakeAllBlankPixels()for x,ak in ipairs(aj)do for y,a3 in ipairs(ak)do new:SetPixel(x,y,a3.TextColour,a3.BackgroundColour,a3.Character)end end end;return new end,SetPixel=function(ad,x,y,w,ae,D)w=w or Current.Colour;ae=ae or Current.Colour;D=D or" "if x<1 or y<1 or x>ad.Artboard.Width or y>ad.Artboard.Height then return end;if ad.Pixels[x][y]then ad.Pixels[x][y]:Set(w,ae,D)ad.Pixels[x][y]:Draw(x,y)end end,MakePixel=function(ad,x,y,ae)ae=ae or ad.BackgroundColour;ad.Pixels[x][y]=Pixel:Initialise(nil,ae,nil,ad)end,MakeColumn=function(ad,x)ad.Pixels[x]={}end,MakeAllBlankPixels=function(ad)for x=1,ad.Artboard.Width do if not ad.Pixels[x]then ad:MakeColumn(x)end;for y=1,ad.Artboard.Height do if not ad.Pixels[x][y]then ad:MakePixel(x,y)end end end end,PixelsInSelection=function(ad,al)local aj={}if Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then local am=Current.Selection[1]local an=Current.Selection[2]local ao=an-am;local ap=am.x;local aq=am.y;for x=1,ao.x+1 do for y=1,ao.y+1 do if not aj[x]then aj[x]={}end;if not ad.Pixels[ap+x-1]or not ad.Pixels[ap+x-1][aq+y-1]then break end;local a3=ad.Pixels[ap+x-1][aq+y-1]aj[x][y]=Pixel:Initialise(a3.TextColour,a3.BackgroundColour,a3.Character,Current.Layer)if al then Current.Layer:SetPixel(ap+x-1,aq+y-1,nil,Current.Layer.BackgroundColour,nil)end end end end;return aj end,EraseSelection=function(ad)if Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then local am=Current.Selection[1]local an=Current.Selection[2]local ao=an-am;local ap=am.x;local aq=am.y;for x=1,ao.x+1 do for y=1,ao.y+1 do Current.Layer:SetPixel(ap+x-1,aq+y-1,nil,Current.Layer.BackgroundColour,nil)end end end end,InsertPixels=function(ad,aj)local ap=Current.Selection[1].x;local aq=Current.Selection[1].y;for x,ak in ipairs(aj)do for y,a3 in ipairs(ak)do Current.Layer:SetPixel(ap+x-1,aq+y-1,a3.TextColour,a3.BackgroundColour,a3.Character)end end end}Artboard={X=0,Y=0,Name="",Path="",Width=1,Height=1,Layers={},Format=nil,SelectionIsBlack=true,Draw=function(ad)Drawing.DrawBlankArea(ad.X+1,ad.Y+1,ad.Width,ad.Height,UIColours.Shadow)local ar;for x=1,ad.Width do ar=x%2;if ar==1 then ar=true else ar=false end;for y=1,ad.Height do if ar then Drawing.WriteToBuffer(ad.X+x-1,ad.Y+y-1,":",UIColours.TransparentBackgroundTwo,UIColours.TransparentBackgroundOne)else Drawing.WriteToBuffer(ad.X+x-1,ad.Y+y-1,":",UIColours.TransparentBackgroundOne,UIColours.TransparentBackgroundTwo)end;ar=not ar end end;for W,af in ipairs(ad.Layers)do af:Draw()end;if Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then local am=Current.Selection[1]local an=Current.Selection[2]local ao=an-am;local as=ad.SelectionIsBlack;local function c()local c=colours.white;if as then c=colours.black end;as=not as;return c end;function horizontal(y)Drawing.WriteToBuffer(ad.X-1+am.x,ad.Y-1+y,'+',c(),colours.transparent)if ao.x>0 then for W=1,ao.x-1 do Drawing.WriteToBuffer(ad.X-1+am.x+W,ad.Y-1+y,'-',c(),colours.transparent)end else for W=1,-1*ao.x-1 do Drawing.WriteToBuffer(ad.X-1+am.x-W,ad.Y-1+y,'-',c(),colours.transparent)end end;Drawing.WriteToBuffer(ad.X-1+am.x+ao.x,ad.Y-1+y,'+',c(),colours.transparent)end;function vertical(x)if ao.y<0 then for W=1,-1*ao.y-1 do Drawing.WriteToBuffer(ad.X-1+x,ad.Y-1+am.y-W,'|',c(),colours.transparent)end else for W=1,ao.y-1 do Drawing.WriteToBuffer(ad.X-1+x,ad.Y-1+am.y+W,'|',c(),colours.transparent)end end end;horizontal(am.y)vertical(am.x)horizontal(am.y+ao.y)vertical(am.x+ao.x)end end,Initialise=function(ad,ag,L,at,au,av,ae,aw)local new={}setmetatable(new,{__index=ad})new.Y=3;new.X=2;new.Name=ag;new.Path=L;new.Width=at;new.Height=au;new.Format=av;new.Layers={}if not aw then new:MakeLayer('Background',ae)else for W,af in ipairs(aw)do new:MakeLayer(af.Name,af.BackgroundColour,af.Index,af.Pixels)new.Layers[W].Visible=af.Visible end;Current.Layer=new.Layers[#new.Layers]end;return new end,Resize=function(ad,ax,ay,left,right)ad.Height=ad.Height+ax+ay;ad.Width=ad.Width+left+right;for W,af in ipairs(ad.Layers)do if left<0 then for x=1,-left do table.remove(af.Pixels,1)end end;if right<0 then for x=1,-right do table.remove(af.Pixels,#af.Pixels)end end;for x=1,left do table.insert(af.Pixels,1,{})for y=1,ad.Height do af:MakePixel(1,y)end end;for x=1,right do table.insert(af.Pixels,{})for y=1,ad.Height do af:MakePixel(#af.Pixels,y)end end;for y=1,ax do for x=1,ad.Width do table.insert(af.Pixels[x],1,{})af:MakePixel(x,1)end end;for y=1,ay do for x=1,ad.Width do table.insert(af.Pixels[x],{})af:MakePixel(x,#af.Pixels[x])end end;if ax<0 then for y=1,-ax do for x=1,ad.Width do table.remove(af.Pixels[x],1)end end end;if ay<0 then for y=1,-ay do for x=1,ad.Width do table.remove(af.Pixels[x],#af.Pixels[x])end end end end end,MakeLayer=function(ad,ag,ae,ai,aj)ae=ae or colours.white;ag=ag or"Layer"local af=Layer:Initialise(ag,ae,ad,ai,aj)table.insert(ad.Layers,af)Current.Layer=af;ModuleNamed('Layers'):Update()return af end,New=function(ad,ag,L,at,au,av,ae,aw)local new=ad:Initialise(ag,L,at,au,av,ae,aw)table.insert(Lists.Artboards,new)Current.Artboard=new;return new end,Save=function(ad,L)Current.Artboard=ad;L=L or ad.Path;local O=io.open;if OneOS then O=OneOS.IO.open end;local P=O(L,"w",true)if ad.Format=='.skch'then P:write(textutils.serialize(SaveSKCH()))else local az={}if ad.Format=='.nfp'then az=SaveNFP()elseif ad.Format=='.nft'then az=SaveNFT()end;for W,aA in ipairs(az)do P:write(aA.."\n")end end;P:close()Current.Modified=false end,Click=function(ad,aB,x,y,aC)if Current.Tool and Current.Layer and Current.Layer.Visible then Current.Tool:Use(x,y,aB,aC)Current.Modified=true;return true end end}Toolbar={X=0,Y=0,Width=0,ExpandedWidth=14,ClosedWidth=2,Height=0,Expanded=true,ToolbarItems={},AbsolutePosition=function(ad)return{X=ad.X,Y=ad.Y}end,Draw=function(ad)ad:CalculateToolbarItemPositions()Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,ad.Height,UIColours.Toolbar)for W,aD in ipairs(ad.ToolbarItems)do aD:Draw()end end,Initialise=function(ad,aB,aE)local new={}setmetatable(new,{__index=ad})new.Expanded=aE;if aE then new.Width=new.ExpandedWidth else new.Width=new.ClosedWidth end;if aB=='right'then new.X=Drawing.Screen.Width-new.Width+1 end;if aB=='right'or aB=='left'then new.Height=Drawing.Screen.Width end;new.Y=1;return new end,AddToolbarItem=function(ad,aF)table.insert(ad.ToolbarItems,aF)ad:CalculateToolbarItemPositions()end,CalculateToolbarItemPositions=function(ad)local H=1;for W,aD in ipairs(ad.ToolbarItems)do aD.Y=H;H=H+aD.Height end end,Update=function(ad)for W,aD in ipairs(ad.ToolbarItems)do if aD.Module.Update then aD.Module:Update(aD)end end end,New=function(ad,aB,aE)local new=ad:Initialise(aB,aE)table.insert(Lists.Interface.Toolbars,new)return new end,Click=function(ad,aB,x,y)return false end}ToolbarItem={X=0,Y=0,Width=0,Height=0,ExpandedHeight=5,Expanded=true,Toolbar=nil,Title="",MenuIcon="=",ExpandedIcon="+",ContractIcon="-",ContentView=nil,Module=nil,MenuItems=nil,Draw=function(ad)Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,1,UIColours.ToolbarItemTitle)Drawing.DrawCharacters(ad.X+1,ad.Y,ad.Title,UIColours.ToolbarText,UIColours.ToolbarItemTitle)Drawing.DrawCharacters(ad.X+ad.Width-1,ad.Y,ad.MenuIcon,UIColours.ToolbarText,UIColours.ToolbarItemTitle)local aG=ad.ContractIcon;if not ad.Expanded then aG=ad.ExpandedIcon end;if ad.Expanded and ad.ContentView then ad.ContentView:Draw()end;Drawing.DrawCharacters(ad.X+ad.Width-2,ad.Y,aG,UIColours.ToolbarText,UIColours.ToolbarItemTitle)end,Initialise=function(ad,aH,au,aE,aI,aJ)local new={}setmetatable(new,{__index=ad})new.Expanded=aE;new.Title=aH.Title;new.Width=aI.Width;new.Height=au or 5;new.Module=aH;new.MenuItems=aJ or{}table.insert(new.MenuItems,{Title='Shrink',Click=function()new:ToggleExpanded()end})new.ExpandedHeight=au or 5;new.Y=1;new.X=aI.X;new.ContentView=ContentView:Initialise(1,2,new.Width,new.Height-1,nil,new)new.Toolbar=aI;return new end,ToggleExpanded=function(ad)ad.Expanded=not ad.Expanded;if ad.Expanded then ad.Height=ad.ExpandedHeight else ad.Height=1 end end,Click=function(ad,aB,x,y)local aK=GetAbsolutePosition(ad)if x==ad.Width and y==1 then local aL="Shrink"if not ad.Expanded then aL="Expand"end;ad.MenuItems[#ad.MenuItems].Title=aL;Menu:New(aK.X+x,aK.Y+y,ad.MenuItems,ad)return true elseif x==ad.Width-1 and y==1 then ad:ToggleExpanded()return true elseif y~=1 then return ad.ContentView:Click(aB,x-ad.ContentView.X+1,y-ad.ContentView.Y+1)end;return false end}ContentView={X=1,Y=1,Width=0,Height=0,Parent=nil,Views={},AbsolutePosition=function(ad)return ad.Parent:AbsolutePosition()end,Draw=function(ad)for W,aM in ipairs(ad.Views)do aM:Draw()end end,Initialise=function(ad,x,y,at,au,aN,aO)local new={}setmetatable(new,{__index=ad})new.Width=at;new.Height=au;new.Y=y;new.X=x;new.Views=aN or{}new.Parent=aO;return new end,Click=function(ad,aB,x,y)for aP,aM in pairs(ad.Views)do if DoClick(aM,aB,x,y)then return true end end end}Button={X=1,Y=1,Width=0,Height=0,BackgroundColour=colours.lightGrey,TextColour=colours.white,ActiveBackgroundColour=colours.lightGrey,Text="",Parent=nil,_Click=nil,Toggle=nil,AbsolutePosition=function(ad)return ad.Parent:AbsolutePosition()end,Draw=function(ad)local aQ=ad.BackgroundColour;local aR=ad.TextColour;if type(aQ)=='function'then aQ=aQ()end;if ad.Toggle then aR=UIColours.MenuBarActive;aQ=ad.ActiveBackgroundColour end;local aK=GetAbsolutePosition(ad)Drawing.DrawBlankArea(aK.X,aK.Y,ad.Width,ad.Height,aQ)Drawing.DrawCharactersCenter(aK.X,aK.Y,ad.Width,ad.Height,ad.Text,aR,aQ)end,Initialise=function(ad,x,y,at,au,ae,aO,aS,text,w,aT,aU)local new={}setmetatable(new,{__index=ad})au=au or 1;new.Width=at or#text+2;new.Height=au;new.Y=y;new.X=x;new.Text=text or""new.BackgroundColour=ae or colours.lightGrey;new.TextColour=w or colours.white;new.ActiveBackgroundColour=aU or colours.lightGrey;new.Parent=aO;new._Click=aS;new.Toggle=aT;return new end,Click=function(ad,aB,x,y)if ad._Click then if ad:_Click(aB,x,y,not ad.Toggle)~=false and ad.Toggle~=nil then ad.Toggle=not ad.Toggle;Draw()end;return true else return false end end}TextBox={X=1,Y=1,Width=0,Height=0,BackgroundColour=colours.lightGrey,TextColour=colours.black,Parent=nil,TextInput=nil,AbsolutePosition=function(ad)return ad.Parent:AbsolutePosition()end,Draw=function(ad)local aK=GetAbsolutePosition(ad)Drawing.DrawBlankArea(aK.X,aK.Y,ad.Width,ad.Height,ad.BackgroundColour)local text=ad.TextInput.Value;if#text>ad.Width-2 then text=text:sub(#text-ad.Width-3)if Current.Input==ad.TextInput then Current.CursorPos={aK.X+1+ad.Width-2,aK.Y}end else if Current.Input==ad.TextInput then Current.CursorPos={aK.X+1+ad.TextInput.CursorPos,aK.Y}end end;Drawing.DrawCharacters(aK.X+1,aK.Y,text,ad.TextColour,ad.BackgroundColour)term.setCursorBlink(true)Current.CursorColour=ad.TextColour end,Initialise=function(ad,x,y,at,au,aO,text,ae,w,aV,aW)local new={}setmetatable(new,{__index=ad})au=au or 1;new.Width=at or#text+2;new.Height=au;new.Y=y;new.X=x;new.TextInput=TextInput:Initialise(text or'',function(key)if aV then aV(key)end;Draw()end,aW)new.BackgroundColour=ae or colours.lightGrey;new.TextColour=w or colours.black;new.Parent=aO;return new end,Click=function(ad,aB,x,y)Current.Input=ad.TextInput;ad:Draw()end}TextInput={Value="",Change=nil,CursorPos=nil,Numerical=false,Initialise=function(ad,a0,aX,aW)local new={}setmetatable(new,{__index=ad})new.Value=a0;new.Change=aX;new.CursorPos=#a0;new.Numerical=aW;return new end,Char=function(ad,char)if ad.Numerical then char=tostring(tonumber(char))end;if char=='nil'then return end;ad.Value=string.sub(ad.Value,1,ad.CursorPos)..char..string.sub(ad.Value,ad.CursorPos+1)ad.CursorPos=ad.CursorPos+1;ad.Change(key)end,Key=function(ad,key)if key==keys.enter then ad.Change(key)elseif key==keys.left then if ad.CursorPos>0 then ad.CursorPos=ad.CursorPos-1;ad.Change(key)end elseif key==keys.right then if ad.CursorPos<string.len(ad.Value)then ad.CursorPos=ad.CursorPos+1;ad.Change(key)end elseif key==keys.backspace then if ad.CursorPos>0 then ad.Value=string.sub(ad.Value,1,ad.CursorPos-1)..string.sub(ad.Value,ad.CursorPos+1)ad.CursorPos=ad.CursorPos-1 end;ad.Change(key)elseif key==keys.home then ad.CursorPos=0;ad.Change(key)elseif key==keys.delete then if ad.CursorPos<string.len(ad.Value)then ad.Value=string.sub(ad.Value,1,ad.CursorPos)..string.sub(ad.Value,ad.CursorPos+2)ad.Change(key)end elseif key==keys["end"]then ad.CursorPos=string.len(ad.Value)ad.Change(key)end end}LayerItem={X=1,Y=1,Parent=nil,Layer=nil,Draw=function(ad)ad.Y=ad.Layer.Index;local aK=GetAbsolutePosition(ad)local aR=colours.lightGrey;if Current.Layer==ad.Layer then aR=colours.white end;Drawing.DrawBlankArea(aK.X,aK.Y,ad.Width,ad.Height,UIColours.Toolbar)Drawing.DrawCharacters(aK.X+3,aK.Y,ad.Layer.Name,aR,UIColours.Toolbar)if ad.Layer.Visible then Drawing.DrawCharacters(aK.X+1,aK.Y,"@",aR,UIColours.Toolbar)else Drawing.DrawCharacters(aK.X+1,aK.Y,"X",aR,UIColours.Toolbar)end end,Initialise=function(ad,af,aO)local new={}setmetatable(new,{__index=ad})new.Width=aO.Width;new.Height=1;new.Y=1;new.X=1;new.Layer=af;new.Parent=aO;return new end,Click=function(ad,aB,x,y)if x==2 then ad.Layer.Visible=not ad.Layer.Visible else Current.Layer=ad.Layer end;return true end}Menu={X=0,Y=0,Width=0,Height=0,Owner=nil,Items={},RemoveTop=false,Draw=function(ad)Drawing.DrawBlankArea(ad.X+1,ad.Y+1,ad.Width,ad.Height,UIColours.Shadow)if not ad.RemoveTop then Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,ad.Height,UIColours.MenuBackground)for W,aF in ipairs(ad.Items)do if aF.Separator then Drawing.DrawArea(ad.X,ad.Y+W,ad.Width,1,'-',colours.grey,UIColours.MenuBackground)else local w=UIColours.MenuText;if aF.Enabled and type(aF.Enabled)=='function'and aF.Enabled()==false or aF.Enabled==false then w=UIColours.MenuDisabledText end;Drawing.DrawCharacters(ad.X+1,ad.Y+W,aF.Title,w,UIColours.MenuBackground)end end else Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,ad.Height,UIColours.MenuBackground)for W,aF in ipairs(ad.Items)do if aF.Separator then Drawing.DrawArea(ad.X,ad.Y+W-1,ad.Width,1,'-',colours.grey,UIColours.MenuBackground)else local w=UIColours.MenuText;if aF.Enabled and type(aF.Enabled)=='function'and aF.Enabled()==false or aF.Enabled==false then w=UIColours.MenuDisabledText end;Drawing.DrawCharacters(ad.X+1,ad.Y+W-1,aF.Title,w,UIColours.MenuBackground)Drawing.DrawCharacters(ad.X-1+ad.Width-#aF.KeyName,ad.Y+W-1,aF.KeyName,w,UIColours.MenuBackground)end end end end,NameForKey=function(ad,key)if key==keys.leftCtrl then return'^'elseif key==keys.tab then return'Tab'elseif key==keys.delete then return'Delete'elseif key==keys.n then return'N'elseif key==keys.s then return'S'elseif key==keys.o then return'O'elseif key==keys.z then return'Z'elseif key==keys.y then return'Y'elseif key==keys.c then return'C'elseif key==keys.x then return'X'elseif key==keys.v then return'V'elseif key==keys.r then return'R'elseif key==keys.l then return'L'elseif key==keys.t then return'T'elseif key==keys.h then return'H'elseif key==keys.e then return'E'elseif key==keys.p then return'P'elseif key==keys.f then return'F'elseif key==keys.m then return'M'else return'?'end end,Initialise=function(ad,x,y,aY,aZ,a_)local new={}setmetatable(new,{__index=ad})if not aZ then return end;local b0={}for W,v in ipairs(aY)do aY[W].KeyName=''if v.Keys then for b1,key in ipairs(v.Keys)do aY[W].KeyName=aY[W].KeyName..ad:NameForKey(key)end end;if aY[W].KeyName~=''then table.insert(b0,aY[W].KeyName)end end;local b2=LongestString(b0)if b2>0 then b2=b2+2 end;new.Width=LongestString(aY,'Title')+2+b2;if new.Width<10 then new.Width=10 end;new.Height=#aY+2;new.RemoveTop=a_ or false;if a_ then new.Height=new.Height-1 end;if y<1 then y=1 end;if x<1 then x=1 end;if y+new.Height>Drawing.Screen.Height+1 then y=Drawing.Screen.Height-new.Height end;if x+new.Width>Drawing.Screen.Width+1 then x=Drawing.Screen.Width-new.Width end;new.Y=y;new.X=x;new.Items=aY;new.Owner=aZ;return new end,New=function(ad,x,y,aY,aZ,a_)if Current.Menu and Current.Menu.Owner==aZ then Current.Menu=nil;return end;local new=ad:Initialise(x,y,aY,aZ,a_)Current.Menu=new;return new end,Click=function(ad,aB,x,y)local W=y-1;if ad.RemoveTop then W=y end;if W>=1 and y<ad.Height then if not(ad.Items[W].Enabled and type(ad.Items[W].Enabled)=='function'and ad.Items[W].Enabled()==false or ad.Items[W].Enabled==false)and ad.Items[W].Click then ad.Items[W]:Click()if Current.Menu.Owner and Current.Menu.Owner.Toggle then Current.Menu.Owner.Toggle=false end;Current.Menu=nil;ad=nil end;return true end end}MenuBar={X=1,Y=1,Width=Drawing.Screen.Width,Height=1,MenuBarItems={},AbsolutePosition=function(ad)return{X=ad.X,Y=ad.Y}end,Draw=function(ad)Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,ad.Height,UIColours.Toolbar)for W,b3 in ipairs(ad.MenuBarItems)do b3:Draw()end end,Initialise=function(ad,aY)local new={}setmetatable(new,{__index=ad})new.X=1;new.Y=1;new.MenuBarItems=aY;return new end,AddToolbarItem=function(ad,aF)table.insert(ad.ToolbarItems,aF)ad:CalculateToolbarItemPositions()end,CalculateToolbarItemPositions=function(ad)local H=1;for W,aD in ipairs(ad.ToolbarItems)do aD.Y=H;H=H+aD.Height end end,Click=function(ad,aB,x,y)for W,aF in ipairs(ad.MenuBarItems)do if aF.X<=x and aF.X+aF.Width>x then if aF:Click(aF,aB,x-aF.X+1,1)then break end end end;return false end}Modules={{Title="Colours",ToolbarItem=nil,Initialise=function(ad)ad.ToolbarItem=ToolbarItem:Initialise(ad,nil,true,Current.Toolbar)local b4={}local W=0;local b5=8;local b6={colours.brown,colours.yellow,colours.orange,colours.red,colours.green,colours.lime,colours.magenta,colours.pink,colours.purple,colours.blue,colours.cyan,colours.lightBlue,colours.lightGrey,colours.grey,colours.black,colours.white}for aP,C in pairs(b6)do if type(C)=='number'and C~=-1 then W=W+1;local y=math.floor(W/b5/2)local x=W%b5/2;if x==0 then x=b5/2;y=y-1 end;table.insert(b4,{X=x*2-2+ad.ToolbarItem.Width-b5,Y=y+1,Width=2,Height=1,BackgroundColour=C,Click=function(ad,aB,x,y)SetColour(ad.BackgroundColour)end})end end;for W,b3 in ipairs(b4)do table.insert(ad.ToolbarItem.ContentView.Views,Button:Initialise(b3.X,b3.Y,b3.Width,b3.Height,b3.BackgroundColour,ad.ToolbarItem.ContentView,b3.Click))end;table.insert(ad.ToolbarItem.ContentView.Views,Button:Initialise(1,1,4,3,function()return Current.Colour end,ad.ToolbarItem.ContentView,nil))Current.Toolbar:AddToolbarItem(ad.ToolbarItem)end},{Title="Tools",ToolbarItem=nil,Update=function(ad)for W,aM in ipairs(ad.ToolbarItem.ContentView.Views)do if Current.Tool and Current.Tool.Name==aM.Text then aM.TextColour=colours.white else aM.TextColour=colours.lightGrey end end;ad.ToolbarItem.ContentView.Views[1].Text='Size: '..Current.ToolSize end,Initialise=function(ad)ad.ToolbarItem=ToolbarItem:Initialise(ad,#Tools+2,true,Current.Toolbar,{{Title="Change Tool Size",Click=function()DisplayToolSizeWindow()end}})table.insert(ad.ToolbarItem.ContentView.Views,Button:Initialise(1,1,ad.ToolbarItem.Width,1,UIColours.Toolbar,ad.ToolbarItem.ContentView,DisplayToolSizeWindow,'Size: '..Current.ToolSize))local y=2;for W,a9 in ipairs(Tools)do table.insert(ad.ToolbarItem.ContentView.Views,Button:Initialise(1,y,ad.ToolbarItem.Width,1,UIColours.Toolbar,ad.ToolbarItem.ContentView,function()SetTool(a9)ad:Update(ad.ToolbarItem)end,a9.Name))y=y+1 end;ad:Update(ad.ToolbarItem)Current.Toolbar:AddToolbarItem(ad.ToolbarItem)end},{Title="Layers",ToolbarItem=nil,Update=function(ad)if Current.Artboard then ad.ToolbarItem.ContentView.Views={}for W=1,#Current.Artboard.Layers do table.insert(ad.ToolbarItem.ContentView.Views,LayerItem:Initialise(Current.Artboard.Layers[#Current.Artboard.Layers-W+1],ad.ToolbarItem.ContentView))end end end,Initialise=function(ad)ad.ToolbarItem=ToolbarItem:Initialise(ad,nil,true,Current.Toolbar,{{Title="New Layer",Click=function()MakeNewLayer()end,Enabled=function()return CheckOpenArtboard()end},{Title='Delete Layer',Click=function()DeleteLayer()end,Enabled=function()return CheckSelectedLayer()end},{Title='Rename Layer...',Click=function()RenameLayer()end,Enabled=function()return CheckSelectedLayer()end}})ad:Update()Current.Toolbar:AddToolbarItem(ad.ToolbarItem)end}}function ModuleNamed(ag)for W,v in ipairs(Modules)do if v.Title==ag then return v end end end;function ToolAffectedPixels(x,y)if not CheckSelectedLayer()then return{}end;if Current.ToolSize==1 then if Current.Layer.Pixels[x]and Current.Layer.Pixels[x][y]then return{{Current.Layer.Pixels[x][y],x,y}}end else local aj={}local ap=x-math.ceil(Current.ToolSize/2)local aq=y-math.ceil(Current.ToolSize/2)for I=1,Current.ToolSize do for J=1,Current.ToolSize do if Current.Layer.Pixels[ap+I]and Current.Layer.Pixels[ap+I][aq+J]then table.insert(aj,{Current.Layer.Pixels[ap+I][aq+J],ap+I,aq+J})end end end;return aj end end;local b7={}Tools={{Name="Hand",Use=function(ad,x,y,aB,aC)Current.Input=nil;if aC and Current.HandDragStart and Current.HandDragStart[1]and Current.HandDragStart[2]then local b8=x-Current.HandDragStart[1]local b9=y-Current.HandDragStart[2]Current.Artboard.X=Current.Artboard.X+b8;Current.Artboard.Y=Current.Artboard.Y+b9 else Current.HandDragStart={x,y}end;sleep(0)end,Select=function(ad)return true end},{Name="Pencil",Use=function(ad,I,J,aB,ah)Current.Input=nil;for W,a3 in ipairs(ToolAffectedPixels(I,J))do if aB==1 then a3[1].BackgroundColour=Current.Colour elseif aB==2 then a3[1].TextColour=Current.Colour end;a3[1]:Draw(a3[2],a3[3])end end,Select=function(ad)return true end},{Name="Eraser",Use=function(ad,x,y,aB)Current.Input=nil;Current.Layer:SetPixel(x,y,nil,Current.Layer.BackgroundColour,nil)for W,a3 in ipairs(ToolAffectedPixels(x,y))do Current.Layer:SetPixel(a3[2],a3[3],nil,Current.Layer.BackgroundColour,nil)end end,Select=function(ad)return true end},{Name="Fill Bucket",Use=function(ad,x,y,aB)local ba=Current.Layer.Pixels[x][y].BackgroundColour;if aB==2 then ba=Current.Layer.Pixels[x][y].TextColour end;local bb={{X=x,Y=y}}while#bb>0 do local bc=bb[1]if Current.Layer.Pixels[bc.X]and Current.Layer.Pixels[bc.X][bc.Y]then local bd=Current.Layer.Pixels[bc.X][bc.Y].BackgroundColour;if aB==2 then bd=Current.Layer.Pixels[bc.X][bc.Y].TextColour end;if bd==ba and bd~=Current.Colour then if aB==1 then Current.Layer.Pixels[bc.X][bc.Y].BackgroundColour=Current.Colour elseif aB==2 then Current.Layer.Pixels[bc.X][bc.Y].TextColour=Current.Colour end;table.insert(bb,{X=bc.X,Y=bc.Y+1})table.insert(bb,{X=bc.X+1,Y=bc.Y})if x>1 then table.insert(bb,{X=bc.X-1,Y=bc.Y})end;if y>1 then table.insert(bb,{X=bc.X,Y=bc.Y-1})end end end;table.remove(bb,1)end;Draw()end,Select=function(ad)return true end},{Name="Select",Use=function(ad,x,y,aB,aC)Current.Input=nil;if not aC then Current.Selection[1]=vector.new(x,y,0)Current.Selection[2]=nil else Current.Selection[2]=vector.new(x,y,0)end end,Select=function(ad)return true end},{Name="Move",Use=function(ad,x,y,aB,aC)Current.Input=nil;if Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then if aC and b7 then local aj=Current.Layer:PixelsInSelection(true)local ao=Current.Selection[1]-Current.Selection[2]Current.Selection[1]=vector.new(x-b7[1],y-b7[2],0)Current.Selection[2]=vector.new(x-b7[1]-ao.x,y-b7[2]-ao.y,0)Current.Layer:InsertPixels(aj)else b7={x-Current.Selection[1].x,y-Current.Selection[1].y}end end end,Select=function(ad)return true end},{Name="Text",Use=function(ad,x,y)Current.Input=TextInput:Initialise('',function(key)if key==keys.delete or key==keys.backspace then if#Current.Input.Value==0 then if Current.Layer.Pixels[x]and Current.Layer.Pixels[x][y]then Current.Layer.Pixels[x][y]:Set(nil,nil,' ')local be=Current.CursorPos[1]-Current.Artboard.X;if be<Current.Artboard.X-1 then be=Current.Artboard.X-1 end;Current.Tool:Use(be,Current.CursorPos[2]-Current.Artboard.Y+1)Draw()end;return else if Current.Layer.Pixels[x+#Current.Input.Value]and Current.Layer.Pixels[x+#Current.Input.Value][y]then Current.Layer.Pixels[x+#Current.Input.Value][y]:Set(nil,nil,' ')end end else local W=#Current.Input.Value;if Current.Layer.Pixels[x+W-1]then Current.Layer.Pixels[x+W-1][y]:Set(Current.Colour,nil,Current.Input.Value:sub(W,W))Current.Layer.Pixels[x+W-1][y]:Draw(x+W-1,y)end end;local be=x+Current.Input.CursorPos;if be>Current.Artboard.Width then Current.Input.CursorPos=Current.Input.CursorPos-1 end;Current.CursorPos={x+Current.Input.CursorPos+Current.Artboard.X-1,y+Current.Artboard.Y-1}Current.CursorColour=Current.Colour;Draw()end)Current.CursorPos={x+Current.Artboard.X-1,y+Current.Artboard.Y-1}Current.CursorColour=Current.Colour end,Select=function(ad)if Current.Artboard.Format=='.nfp'then ButtonDialougeWindow:Initialise('NFP does not support text!','The format you are using, NFP, does not support text. Use NFT or SKCH to use text.','Ok',nil,function(a7)a7:Close()end):Show()return false else return true end end}}function ToolNamed(ag)for W,v in ipairs(Tools)do if v.Name==ag then return v end end end;NewDocumentWindow={X=1,Y=1,Width=0,Height=0,CursorPos=1,Visible=true,Return=nil,OkButton=nil,Format='.skch',ImageBackgroundColour=colours.white,NameLabelHighlight=false,SizeLabelHighlight=false,AbsolutePosition=function(ad)return{X=ad.X,Y=ad.Y}end,Draw=function(ad)if not ad.Visible then return end;Drawing.DrawBlankArea(ad.X+1,ad.Y+1,ad.Width,ad.Height,colours.grey)Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,1,colours.lightGrey)Drawing.DrawBlankArea(ad.X,ad.Y+1,ad.Width,ad.Height-1,colours.white)Drawing.DrawCharactersCenter(ad.X,ad.Y,ad.Width,1,ad.Title,colours.black,colours.lightGrey)local bf=colours.black;if ad.NameLabelHighlight then bf=colours.red end;Drawing.DrawCharacters(ad.X+1,ad.Y+2,"Name",bf,colours.white)Drawing.DrawCharacters(ad.X+1,ad.Y+4,"Type",colours.black,colours.white)local bg=colours.black;if ad.SizeLabelHighlight then bg=colours.red end;Drawing.DrawCharacters(ad.X+1,ad.Y+6,"Size",bg,colours.white)Drawing.DrawCharacters(ad.X+11,ad.Y+6,"x",colours.black,colours.white)Drawing.DrawCharacters(ad.X+1,ad.Y+8,"Background",colours.black,colours.white)ad.OkButton:Draw()ad.CancelButton:Draw()ad.SKCHButton:Draw()ad.NFTButton:Draw()ad.NFPButton:Draw()ad.PathTextBox:Draw()ad.WidthTextBox:Draw()ad.HeightTextBox:Draw()ad.WhiteButton:Draw()ad.BlackButton:Draw()ad.TransparentButton:Draw()end,Initialise=function(ad,bh)local new={}setmetatable(new,{__index=ad})new.Width=32;new.Height=13;new.Return=bh;new.X=math.ceil((Drawing.Screen.Width-new.Width)/2)new.Y=math.ceil((Drawing.Screen.Height-new.Height)/2)new.Title='New Document'new.Visible=true;new.NameLabelHighlight=false;new.SizeLabelHighlight=false;new.Format='.skch'new.OkButton=Button:Initialise(new.Width-4,new.Height-1,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)local L=new.PathTextBox.TextInput.Value;local bi=true;new.NameLabelHighlight=false;new.SizeLabelHighlight=false;local N=fs;if OneOS then N=OneOS.FS end;if L:sub(-1)=='/'or N.isDir(L)or#L==0 then bi=false;new.NameLabelHighlight=true end;if#new.WidthTextBox.TextInput.Value==0 or tonumber(new.WidthTextBox.TextInput.Value)<=0 then bi=false;new.SizeLabelHighlight=true end;if#new.HeightTextBox.TextInput.Value==0 or tonumber(new.HeightTextBox.TextInput.Value)<=0 then bi=false;new.SizeLabelHighlight=true end;if bi then bh(new,true,L,tonumber(new.WidthTextBox.TextInput.Value),tonumber(new.HeightTextBox.TextInput.Value),new.Format,new.ImageBackgroundColour)else Draw()end end,'Ok',colours.black)new.CancelButton=Button:Initialise(new.Width-13,new.Height-1,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)bh(new,false)end,'Cancel',colours.black)new.SKCHButton=Button:Initialise(7,5,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)new.NFTButton.Toggle=false;new.NFPButton.Toggle=false;ad.Toggle=false;new.Format='.skch'end,'.skch',colours.black,true,colours.lightBlue)new.NFTButton=Button:Initialise(15,5,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)new.SKCHButton.Toggle=false;new.NFPButton.Toggle=false;ad.Toggle=false;new.Format='.nft'end,'.nft',colours.black,false,colours.lightBlue)new.NFPButton=Button:Initialise(22,5,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)new.SKCHButton.Toggle=false;new.NFTButton.Toggle=false;ad.Toggle=false;new.Format='.nfp'end,'.nfp',colours.black,false,colours.lightBlue)local L=''if OneOS then L='/Desktop/'end;new.PathTextBox=TextBox:Initialise(7,3,new.Width-7,1,new,L,nil,nil,function(key)if key==keys.enter or key==keys.tab then Current.Input=new.WidthTextBox.TextInput end end)new.WidthTextBox=TextBox:Initialise(7,7,4,1,new,tostring(15),nil,nil,function()if key==keys.enter or key==keys.tab then Current.Input=new.HeightTextBox.TextInput end end,true)new.HeightTextBox=TextBox:Initialise(14,7,4,1,new,tostring(10),nil,nil,function()if key==keys.enter or key==keys.tab then Current.Input=new.PathTextBox.TextInput end end,true)Current.Input=new.PathTextBox.TextInput;new.WhiteButton=Button:Initialise(2,10,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)new.TransparentButton.Toggle=false;new.BlackButton.Toggle=false;ad.Toggle=false;new.ImageBackgroundColour=colours.white end,'White',colours.black,true,colours.lightBlue)new.BlackButton=Button:Initialise(10,10,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)new.TransparentButton.Toggle=false;new.WhiteButton.Toggle=false;ad.Toggle=false;new.ImageBackgroundColour=colours.black end,'Black',colours.black,false,colours.lightBlue)new.TransparentButton=Button:Initialise(18,10,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)new.WhiteButton.Toggle=false;new.BlackButton.Toggle=false;ad.Toggle=false;new.ImageBackgroundColour=colours.transparent end,'Transparent',colours.black,false,colours.lightBlue)return new end,Show=function(ad)Current.Window=ad;return ad end,Close=function(ad)Current.Input=nil;Current.Window=nil;ad=nil end,Flash=function(ad)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()sleep(0.15)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()end,ButtonClick=function(ad,b3,x,y)if b3.X<=x and b3.Y<=y and b3.X+b3.Width>x and b3.Y+b3.Height>y then b3:Click()end end,Click=function(ad,aB,x,y)local aY={ad.OkButton,ad.CancelButton,ad.SKCHButton,ad.NFTButton,ad.NFPButton,ad.PathTextBox,ad.WidthTextBox,ad.HeightTextBox,ad.WhiteButton,ad.BlackButton,ad.TransparentButton}for W,v in ipairs(aY)do if CheckClick(v,x,y)then v:Click(aB,x,y)end end;return true end}local bj=function(L)L='/'..L;local N=fs;if OneOS then N=OneOS.FS end;if N.isDir(L)then L=L..'/'end;L,n=L:gsub("//","/")while n>0 do L,n=L:gsub("//","/")end;return L end;local bk=function(text,bl)local az={''}for bm,bn in text:gmatch('(%S+)(%s*)')do local bo=az[#az]..bm..bn:gsub('\n','')if#bo>bl then table.insert(az,'')end;if bn:find('\n')then az[#az]=az[#az]..bm;bn=bn:gsub('\n',function()table.insert(az,'')return''end)else az[#az]=az[#az]..bm..bn end end;return az end;OpenDocumentWindow={X=1,Y=1,Width=0,Height=0,CursorPos=1,Visible=true,Return=nil,OpenButton=nil,PathTextBox=nil,CurrentDirectory='/',Scroll=0,MaxScroll=0,GoUpButton=nil,SelectedFile='',Files={},Typed=false,AbsolutePosition=function(ad)return{X=ad.X,Y=ad.Y}end,Draw=function(ad)if not ad.Visible then return end;Drawing.DrawBlankArea(ad.X+1,ad.Y+1,ad.Width,ad.Height,colours.grey)Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,3,colours.lightGrey)Drawing.DrawBlankArea(ad.X,ad.Y+1,ad.Width,ad.Height-6,colours.white)Drawing.DrawCharactersCenter(ad.X,ad.Y,ad.Width,1,ad.Title,colours.black,colours.lightGrey)Drawing.DrawBlankArea(ad.X,ad.Y+ad.Height-5,ad.Width,5,colours.lightGrey)ad:DrawFiles()local N=fs;if OneOS then N=OneOS.FS end;if N.exists(ad.PathTextBox.TextInput.Value)or ad.SelectedFile and#ad.SelectedFile>0 and N.exists(ad.CurrentDirectory..ad.SelectedFile)then ad.OpenButton.TextColour=colours.black else ad.OpenButton.TextColour=colours.lightGrey end;ad.PathTextBox:Draw()ad.OpenButton:Draw()ad.CancelButton:Draw()ad.GoUpButton:Draw()end,DrawFiles=function(ad)local N=fs;if OneOS then N=OneOS.FS end;for W,P in ipairs(ad.Files)do if W>ad.Scroll and W-ad.Scroll<=11 then if P==ad.SelectedFile then Drawing.DrawCharacters(ad.X+1,ad.Y+W-ad.Scroll,P,colours.white,colours.lightBlue)elseif string.find(P,'%.skch')or string.find(P,'%.nft')or string.find(P,'%.nfp')or N.isDir(ad.CurrentDirectory..P)then Drawing.DrawCharacters(ad.X+1,ad.Y+W-ad.Scroll,P,colours.black,colours.white)else Drawing.DrawCharacters(ad.X+1,ad.Y+W-ad.Scroll,P,colours.grey,colours.white)end end end;ad.MaxScroll=#ad.Files-11;if ad.MaxScroll<0 then ad.MaxScroll=0 end end,Initialise=function(ad,bh)local new={}setmetatable(new,{__index=ad})new.Width=32;new.Height=17;new.Return=bh;new.X=math.ceil((Drawing.Screen.Width-new.Width)/2)new.Y=math.ceil((Drawing.Screen.Height-new.Height)/2)new.Title='Open Document'new.Visible=true;new.CurrentDirectory='/'new.SelectedFile=nil;if OneOS then new.CurrentDirectory='/Desktop/'end;local N=fs;if OneOS then N=OneOS.FS end;new.OpenButton=Button:Initialise(new.Width-6,new.Height-1,nil,nil,colours.white,new,function(ad,aB,x,y,aT)if N.exists(new.PathTextBox.TextInput.Value)and ad.TextColour==colours.black and not N.isDir(new.PathTextBox.TextInput.Value)then bh(new,true,bj(new.PathTextBox.TextInput.Value))elseif new.SelectedFile and ad.TextColour==colours.black and N.isDir(new.CurrentDirectory..new.SelectedFile)then new:GoToDirectory(new.CurrentDirectory..new.SelectedFile)elseif new.SelectedFile and ad.TextColour==colours.black then bh(new,true,bj(new.CurrentDirectory..'/'..new.SelectedFile))end end,'Open',colours.black)new.CancelButton=Button:Initialise(new.Width-15,new.Height-1,nil,nil,colours.white,new,function(ad,aB,x,y,aT)bh(new,false)end,'Cancel',colours.black)new.GoUpButton=Button:Initialise(2,new.Height-1,nil,nil,colours.white,new,function(ad,aB,x,y,aT)local bp=N.getName(new.CurrentDirectory)local bq=new.CurrentDirectory:sub(1,#new.CurrentDirectory-#bp-1)new:GoToDirectory(bq)end,'Go Up',colours.black)new.PathTextBox=TextBox:Initialise(2,new.Height-3,new.Width-2,1,new,new.CurrentDirectory,colours.white,colours.black)new:GoToDirectory(new.CurrentDirectory)return new end,Show=function(ad)Current.Window=ad;return ad end,Close=function(ad)Current.Input=nil;Current.Window=nil;ad=nil end,GoToDirectory=function(ad,L)L=bj(L)ad.CurrentDirectory=L;ad.Scroll=0;ad.SelectedFile=nil;ad.Typed=false;ad.PathTextBox.TextInput.Value=L;local N=fs;if OneOS then N=OneOS.FS end;ad.Files=N.list(ad.CurrentDirectory)Draw()end,Flash=function(ad)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()sleep(0.15)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()end,Click=function(ad,aB,x,y)local aY={ad.OpenButton,ad.CancelButton,ad.PathTextBox,ad.GoUpButton}local br=false;for W,v in ipairs(aY)do if CheckClick(v,x,y)then v:Click(aB,x,y)br=true end end;if not br then if y<=12 then local N=fs;if OneOS then N=OneOS.FS end;ad.SelectedFile=N.list(ad.CurrentDirectory)[y-1]ad.PathTextBox.TextInput.Value=bj(ad.CurrentDirectory..'/'..ad.SelectedFile)Draw()end end;return true end}ButtonDialougeWindow={X=1,Y=1,Width=0,Height=0,CursorPos=1,Visible=true,CancelButton=nil,OkButton=nil,Lines={},AbsolutePosition=function(ad)return{X=ad.X,Y=ad.Y}end,Draw=function(ad)if not ad.Visible then return end;Drawing.DrawBlankArea(ad.X+1,ad.Y+1,ad.Width,ad.Height,colours.grey)Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,1,colours.lightGrey)Drawing.DrawBlankArea(ad.X,ad.Y+1,ad.Width,ad.Height-1,colours.white)Drawing.DrawCharactersCenter(ad.X,ad.Y,ad.Width,1,ad.Title,colours.black,colours.lightGrey)for W,text in ipairs(ad.Lines)do Drawing.DrawCharacters(ad.X+1,ad.Y+1+W,text,colours.black,colours.white)end;ad.OkButton:Draw()if ad.CancelButton then ad.CancelButton:Draw()end end,Initialise=function(ad,bs,bt,bu,bv,bh)local new={}setmetatable(new,{__index=ad})new.Width=28;new.Lines=bk(bt,new.Width-2)new.Height=5+#new.Lines;new.Return=bh;new.X=math.ceil((Drawing.Screen.Width-new.Width)/2)new.Y=math.ceil((Drawing.Screen.Height-new.Height)/2)new.Title=bs;new.Visible=true;new.Visible=true;new.OkButton=Button:Initialise(new.Width-#bu-2,new.Height-1,nil,1,nil,new,function()bh(new,true)end,bu)if bv then new.CancelButton=Button:Initialise(new.Width-#bu-2-1-#bv-2,new.Height-1,nil,1,nil,new,function()bh(new,false)end,bv)end;return new end,Show=function(ad)Current.Window=ad;return ad end,Close=function(ad)Current.Window=nil;ad=nil end,Flash=function(ad)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()sleep(0.15)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()end,Click=function(ad,aB,x,y)local aY={ad.OkButton,ad.CancelButton}local br=false;for W,v in ipairs(aY)do if CheckClick(v,x,y)then v:Click(aB,x,y)br=true end end;return true end}TextDialougeWindow={X=1,Y=1,Width=0,Height=0,CursorPos=1,Visible=true,CancelButton=nil,OkButton=nil,Lines={},TextInput=nil,AbsolutePosition=function(ad)return{X=ad.X,Y=ad.Y}end,Draw=function(ad)if not ad.Visible then return end;Drawing.DrawBlankArea(ad.X+1,ad.Y+1,ad.Width,ad.Height,colours.grey)Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,1,colours.lightGrey)Drawing.DrawBlankArea(ad.X,ad.Y+1,ad.Width,ad.Height-1,colours.white)Drawing.DrawCharactersCenter(ad.X,ad.Y,ad.Width,1,ad.Title,colours.black,colours.lightGrey)for W,text in ipairs(ad.Lines)do Drawing.DrawCharacters(ad.X+1,ad.Y+1+W,text,colours.black,colours.white)end;Drawing.DrawBlankArea(ad.X+1,ad.Y+ad.Height-4,ad.Width-2,1,colours.lightGrey)Drawing.DrawCharacters(ad.X+2,ad.Y+ad.Height-4,ad.TextInput.Value,colours.black,colours.lightGrey)Current.CursorPos={ad.X+2+ad.TextInput.CursorPos,ad.Y+ad.Height-4}Current.CursorColour=colours.black;ad.OkButton:Draw()if ad.CancelButton then ad.CancelButton:Draw()end end,Initialise=function(ad,bs,bt,bu,bv,bh,aW)local new={}setmetatable(new,{__index=ad})new.Width=28;new.Lines=bk(bt,new.Width-2)new.Height=7+#new.Lines;new.Return=bh;new.X=math.ceil((Drawing.Screen.Width-new.Width)/2)new.Y=math.ceil((Drawing.Screen.Height-new.Height)/2)new.Title=bs;new.Visible=true;new.Visible=true;new.OkButton=Button:Initialise(new.Width-#bu-2,new.Height-1,nil,1,nil,new,function()if#new.TextInput.Value>0 then bh(new,true,new.TextInput.Value)end end,bu)if bv then new.CancelButton=Button:Initialise(new.Width-#bu-2-1-#bv-2,new.Height-1,nil,1,nil,new,function()bh(new,false)end,bv)end;new.TextInput=TextInput:Initialise('',function(enter)if enter then new.OkButton:Click()end;Draw()end,aW)Current.Input=new.TextInput;return new end,Show=function(ad)Current.Window=ad;return ad end,Close=function(ad)Current.Window=nil;Current.Input=nil;ad=nil end,Flash=function(ad)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()sleep(0.15)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()end,Click=function(ad,aB,x,y)local aY={ad.OkButton,ad.CancelButton}local br=false;for W,v in ipairs(aY)do if CheckClick(v,x,y)then v:Click(aB,x,y)br=true end end;return true end}ResizeDocumentWindow={X=1,Y=1,Width=0,Height=0,CursorPos=1,Visible=true,Return=nil,OkButton=nil,AnchorPosition=5,WidthLabelHighlight=false,HeightLabelHighlight=false,AbsolutePosition=function(ad)return{X=ad.X,Y=ad.Y}end,Draw=function(ad)if not ad.Visible then return end;Drawing.DrawBlankArea(ad.X+1,ad.Y+1,ad.Width,ad.Height,colours.grey)Drawing.DrawBlankArea(ad.X,ad.Y,ad.Width,1,colours.lightGrey)Drawing.DrawBlankArea(ad.X,ad.Y+1,ad.Width,ad.Height-1,colours.white)Drawing.DrawCharactersCenter(ad.X,ad.Y,ad.Width,1,ad.Title,colours.black,colours.lightGrey)Drawing.DrawCharacters(ad.X+1,ad.Y+2,"New Size",colours.lightGrey,colours.white)if#ad.WidthTextBox.TextInput.Value>0 and tonumber(ad.WidthTextBox.TextInput.Value)<Current.Artboard.Width or#ad.HeightTextBox.TextInput.Value>0 and tonumber(ad.HeightTextBox.TextInput.Value)<Current.Artboard.Height then Drawing.DrawCharacters(ad.X+1,ad.Y+8,"Clipping will occur!",colours.red,colours.white)end;local bw=colours.black;if ad.WidthLabelHighlight then bw=colours.red end;local bx=colours.black;if ad.HeightLabelHighlight then bx=colours.red end;Drawing.DrawCharacters(ad.X+1,ad.Y+4,"Width",bw,colours.white)Drawing.DrawCharacters(ad.X+1,ad.Y+6,"Height",bx,colours.white)Drawing.DrawCharacters(ad.X+14,ad.Y+2,"Anchor",colours.lightGrey,colours.white)ad.WidthTextBox:Draw()ad.HeightTextBox:Draw()ad.OkButton:Draw()ad.Anchor1:Draw()ad.Anchor2:Draw()ad.Anchor3:Draw()ad.Anchor4:Draw()ad.Anchor5:Draw()ad.Anchor6:Draw()ad.Anchor7:Draw()ad.Anchor8:Draw()ad.Anchor9:Draw()end,Initialise=function(ad,bh)local new={}setmetatable(new,{__index=ad})new.Width=27;new.Height=10;new.Return=bh;new.X=math.ceil((Drawing.Screen.Width-new.Width)/2)new.Y=math.ceil((Drawing.Screen.Height-new.Height)/2)new.Title='Resize Document'new.Visible=true;new.WidthTextBox=TextBox:Initialise(9,5,4,1,new,tostring(Current.Artboard.Width),nil,nil,function()new:UpdateAnchorButtons()end,true)new.HeightTextBox=TextBox:Initialise(9,7,4,1,new,tostring(Current.Artboard.Height),nil,nil,function()new:UpdateAnchorButtons()end,true)new.OkButton=Button:Initialise(new.Width-4,new.Height-1,nil,nil,colours.lightGrey,new,function(ad,aB,x,y,aT)local bi=true;new.WidthLabelHighlight=false;new.HeightLabelHighlight=false;if#new.WidthTextBox.TextInput.Value==0 or tonumber(new.WidthTextBox.TextInput.Value)<=0 then bi=false;new.WidthLabelHighlight=true end;if#new.HeightTextBox.TextInput.Value==0 or tonumber(new.HeightTextBox.TextInput.Value)<=0 then bi=false;new.HeightLabelHighlight=true end;if bi then bh(new,tonumber(new.WidthTextBox.TextInput.Value),tonumber(new.HeightTextBox.TextInput.Value),new.AnchorPosition)else Draw()end end,'Ok',colours.black)local by=15;local bz=5;new.Anchor1=Button:Initialise(by,bz,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=1;new:UpdateAnchorButtons()end,' ',colours.black)new.Anchor2=Button:Initialise(by+1,bz,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=2;new:UpdateAnchorButtons()end,'^',colours.black)new.Anchor3=Button:Initialise(by+2,bz,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=3;new:UpdateAnchorButtons()end,' ',colours.black)new.Anchor4=Button:Initialise(by,bz+1,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=4;new:UpdateAnchorButtons()end,'<',colours.black)new.Anchor5=Button:Initialise(by+1,bz+1,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=5;new:UpdateAnchorButtons()end,'#',colours.black)new.Anchor6=Button:Initialise(by+2,bz+1,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=6;new:UpdateAnchorButtons()end,'>',colours.black)new.Anchor7=Button:Initialise(by,bz+2,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=7;new:UpdateAnchorButtons()end,' ',colours.black)new.Anchor8=Button:Initialise(by+1,bz+2,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=8;new:UpdateAnchorButtons()end,'v',colours.black)new.Anchor9=Button:Initialise(by+2,bz+2,1,1,colours.lightGrey,new,function(ad,aB,x,y,aT)new.AnchorPosition=9;new:UpdateAnchorButtons()end,' ',colours.black)return new end,UpdateAnchorButtons=function(ad)local bA=' 'local bB=' 'local bC=' 'local bD=' 'local bE=' 'local bF=' 'local bG=' 'local bH=' 'local bI=' 'ad.AnchorPosition=ad.AnchorPosition or 5;if ad.AnchorPosition==1 then bA='#'bB='>'bD='v'elseif ad.AnchorPosition==2 then bA='<'bB='#'bC='>'bE='v'elseif ad.AnchorPosition==3 then bB='<'bC='#'bF='v'elseif ad.AnchorPosition==4 then bA='^'bD='#'bE='>'bG='v'elseif ad.AnchorPosition==5 then bB='^'bD='<'bE='#'bF='>'bH='v'elseif ad.AnchorPosition==6 then bC='^'bF='#'bE='<'bI='v'elseif ad.AnchorPosition==7 then bD='^'bG='#'bH='>'elseif ad.AnchorPosition==8 then bE='^'bH='#'bG='<'bI='>'elseif ad.AnchorPosition==9 then bF='^'bI='#'bH='<'end;if#ad.HeightTextBox.TextInput.Value>0 and Current.Artboard.Height>tonumber(ad.HeightTextBox.TextInput.Value)then local r=function(bJ)if string.find(bJ,"%^")then bJ=bJ:gsub('%^','v')elseif string.find(bJ,"v")then bJ=bJ:gsub('v','%^')end;return bJ end;bA=r(bA)bB=r(bB)bC=r(bC)bD=r(bD)bE=r(bE)bF=r(bF)bG=r(bG)bH=r(bH)bI=r(bI)end;if#ad.WidthTextBox.TextInput.Value>0 and Current.Artboard.Width>tonumber(ad.WidthTextBox.TextInput.Value)then local r=function(bJ)if string.find(bJ,">")then bJ=bJ:gsub('>','<')elseif string.find(bJ,"<")then bJ=bJ:gsub('<','>')end;return bJ end;bA=r(bA)bB=r(bB)bC=r(bC)bD=r(bD)bE=r(bE)bF=r(bF)bG=r(bG)bH=r(bH)bI=r(bI)end;ad.Anchor1.Text=bA;ad.Anchor2.Text=bB;ad.Anchor3.Text=bC;ad.Anchor4.Text=bD;ad.Anchor5.Text=bE;ad.Anchor6.Text=bF;ad.Anchor7.Text=bG;ad.Anchor8.Text=bH;ad.Anchor9.Text=bI end,Show=function(ad)Current.Window=ad;return ad end,Close=function(ad)Current.Input=nil;Current.Window=nil;ad=nil end,Flash=function(ad)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()sleep(0.15)ad.Visible=false;Draw()sleep(0.15)ad.Visible=true;Draw()end,ButtonClick=function(ad,b3,x,y)if b3.X<=x and b3.Y<=y and b3.X+b3.Width>x and b3.Y+b3.Height>y then b3:Click()end end,Click=function(ad,aB,x,y)local aY={ad.OkButton,ad.WidthTextBox,ad.HeightTextBox,ad.Anchor1,ad.Anchor2,ad.Anchor3,ad.Anchor4,ad.Anchor5,ad.Anchor6,ad.Anchor7,ad.Anchor8,ad.Anchor9}for W,v in ipairs(aY)do if CheckClick(v,x,y)then v:Click(aB,x,y)end end;return true end}function CheckOpenArtboard()if Current.Artboard then return true else return false end end;function CheckSelectedLayer()if Current.Artboard and Current.Layer then return true else return false end end;function DisplayNewDocumentWindow()NewDocumentWindow:Initialise(function(ad,a8,L,at,au,av,ae)if a8 then if L:sub(-4)~=av then L=L..av end;local bK=ad;Current.Input=nil;Current.Window=nil;makeDocument=function()bK:Close()NewDocument(L,at,au,av,ae)end;local N=fs;if OneOS then N=OneOS.FS end;if N.exists(L)then ButtonDialougeWindow:Initialise('File Exists',L..' already exists! Use a different name and try again.','Ok',nil,function(a7,bi)a7:Close()bK:Show()end):Show()elseif av=='.nfp'then Current.Window=nil;ButtonDialougeWindow:Initialise('Use NFP?','The NFT format does not support text or layers, if you use it you will only be able to use 1 layer and not have any text.','Use NFP','Cancel',function(a7,bi)a7:Close()if bi then makeDocument()else bK:Show()end end):Show()elseif av=='.nft'then ButtonDialougeWindow:Initialise('Use NFT?','The NFT format does not support layers, if you use it you will only be able to use 1 layer.','Use NFT','Cancel',function(a7,bi)a7:Close()if bi then makeDocument()else bK:Show()end end):Show()else makeDocument()end else ad:Close()end end):Show()end;function NewDocument(L,at,au,av,ae)local N=fs;if OneOS then N=OneOS.FS end;ab=Artboard:New(N.getName(L),L,at,au,av,ae)Current.Tool=Tools[2]Current.Toolbar:Update()Current.Modified=false;Draw()end;function DisplayToolSizeWindow()if not CheckOpenArtboard()then return end;TextDialougeWindow:Initialise('Change Tool Size','Enter the new tool size you\'d like to use.','Ok','Cancel',function(a7,a8,a0)if a8 then Current.ToolSize=math.ceil(tonumber(a0))if Current.ToolSize<1 then Current.ToolSize=1 elseif Current.ToolSize>50 then Current.ToolSize=50 end;ModuleNamed('Tools'):Update()end;a7:Close()end,true):Show()end;function GetFormat(L)local N=fs;if OneOS then N=OneOS.FS end;local P=N.open(L,'r')local k=P.readAll()P.close()if type(textutils.unserialize(k))=='table'then return'.skch'elseif string.find(k,string.char(30))or string.find(k,string.char(31))then return'.nft'else return'.nfp'end end;function DisplayOpenDocumentWindow()OpenDocumentWindow:Initialise(function(ad,a8,L)ad:Close()if a8 then OpenDocument(L)end end):Show()end;local function bL(L,bM)if not L then return nil elseif not string.find(fs.getName(L),'%.')then if not bM then return fs.getName(L)else return''end else local bN=L;if L:sub(#L)=='/'then bN=L:sub(1,#L-1)end;local bO=bN:gmatch('%.[0-9a-z]+$')()if bO then bO=bO:sub(2)else return''end;if bM then bO='.'..bO end;return bO:lower()end end;local bP=function(L)if L:sub(1,1)=='.'then return L end;local bO=bL(L)if bO==L then return fs.getName(L)end;return string.gsub(L,bO,''):sub(1,-2)end;function OpenDocument(L)local N=fs;if OneOS then N=OneOS.FS end;if N.exists(L)and not N.isDir(L)then local av=bL(L,true)if(not av or av=='')and av~='.nfp'and av~='.nft'and av~='.skch'then av=GetFormat(L)end;local aw={}if av=='.nfp'then aw=ReadNFP(L)elseif av=='.nft'then aw=ReadNFT(L)elseif av=='.skch'then aw=ReadSKCH(L)end;for W,af in ipairs(aw)do if af.Visible==nil then af.Visible=true end;if af.Index==nil then af.Index=1 end;if af.Name==nil then if af.Index==1 then af.Name='Background'else af.Name='Layer'end end;if af.BackgroundColour==nil then af.BackgroundColour=colours.white end end;if not aw[1]then return end;local at=#aw[1].Pixels;local au=#aw[1].Pixels[1]Current.Artboard=nil;local N=fs;if OneOS then N=OneOS.FS end;ab=Artboard:New(N.getName('Image'),L,at,au,av,nil,aw)Current.Tool=Tools[2]Current.Toolbar:Update()Current.Modified=false;Draw()end end;function MakeNewLayer()if not CheckOpenArtboard()then return end;if Current.Artboard.Format=='.skch'then TextDialougeWindow:Initialise('New Layer Name','Enter the name you want for the next layer.','Ok','Cancel',function(a7,a8,a0)if a8 then Current.Artboard:MakeLayer(a0,colours.transparent)end;a7:Close()end):Show()else local av='NFP'if Current.Artboard.Format=='.nft'then av='NFT'end;ButtonDialougeWindow:Initialise(av..' does not support layers!','The format you are using, '..av..', does not support multiple layers. Use SKCH to have more than one layer.','Ok',nil,function(a7)a7:Close()end):Show()end end;function ResizeDocument()if not CheckOpenArtboard()then return end;ResizeDocumentWindow:Initialise(function(a7,at,au,bQ)a7:Close()local bR=0;local bS=0;local bT=0;local bU=0;if bQ==1 then bS=1;bT=1 elseif bQ==2 then bS=0.5;bU=0.5;bT=1 elseif bQ==3 then bU=1;bT=1 elseif bQ==4 then bS=1;bT=0.5;bR=0.5 elseif bQ==5 then bS=0.5;bU=0.5;bT=0.5;bR=0.5 elseif bQ==6 then bU=1;bT=0.5;bR=0.5 elseif bQ==7 then bS=1;bR=1 elseif bQ==8 then bS=0.5;bU=0.5;bR=1 elseif bQ==9 then bU=1;bR=1 end;bR=bR*au-Current.Artboard.Height;if bR>0 then bR=math.floor(bR)else bR=math.ceil(bR)end;bT=bT*au-Current.Artboard.Height;if bT>0 then bT=math.ceil(bT)else bT=math.floor(bT)end;bU=bU*at-Current.Artboard.Width;if bU>0 then bU=math.floor(bU)else bU=math.ceil(bU)end;bS=bS*at-Current.Artboard.Width;if bS>0 then bS=math.ceil(bS)else bS=math.floor(bS)end;Current.Artboard:Resize(bR,bT,bU,bS)end):Show()end;function RenameLayer()if not CheckOpenArtboard()then return end;if Current.Artboard.Format=='.skch'then TextDialougeWindow:Initialise("Rename Layer '"..Current.Layer.Name.."'",'Enter the new name you want the layer to be called.','Ok','Cancel',function(a7,a8,a0)if a8 then Current.Layer.Name=a0 end;a7:Close()end):Show()else local av='NFP'if Current.Artboard.Format=='.nft'then av='NFT'end;ButtonDialougeWindow:Initialise(av..' does not support layers!','The format you are using, '..av..', does not support renaming layers. Use SKCH to rename layers.','Ok',nil,function(a7)a7:Close()end):Show()end end;function DeleteLayer()if not CheckOpenArtboard()then return end;if Current.Artboard.Format=='.skch'then if#Current.Artboard.Layers>1 then ButtonDialougeWindow:Initialise("Delete Layer '"..Current.Layer.Name.."'?",'Are you sure you want delete the layer?','Ok','Cancel',function(a7,a8)if a8 then Current.Layer:Remove()end;a7:Close()end):Show()else ButtonDialougeWindow:Initialise('Can not delete layer!','You can not delete the last layer of an image! Make another layer to delete this one.','Ok',nil,function(a7)a7:Close()end):Show()end else local av='NFP'if Current.Artboard.Format=='.nft'then av='NFT'end;ButtonDialougeWindow:Initialise(av..' does not support layers!','The format you are using, '..av..', does not support deleting layers. Use SKCH to deleting layers.','Ok',nil,function(a7)a7:Close()end):Show()end end;needsDraw=false;isDrawing=false;function Draw()if isDrawing then needsDraw=true;return end;needsDraw=false;isDrawing=true;if not Current.Window then Drawing.Clear(UIColours.Background)else Drawing.DrawArea(1,2,Drawing.Screen.Width,Drawing.Screen.Height,'|',colours.black,colours.lightGrey)end;if Current.Artboard then ab:Draw()end;if Current.InterfaceVisible then Current.MenuBar:Draw()Current.Toolbar.Width=Current.Toolbar.ExpandedWidth;Current.Toolbar:Draw()else Current.Toolbar.Width=Current.Toolbar.ExpandedWidth end;if Current.InterfaceVisible and Current.Menu then Current.Menu:Draw()end;if Current.Window then Current.Window:Draw()end;if not Current.InterfaceVisible then ShowInterfaceButton:Draw()end;Drawing.DrawBuffer()if Current.Input and not Current.Menu then term.setCursorPos(Current.CursorPos[1],Current.CursorPos[2])term.setCursorBlink(true)term.setTextColour(Current.CursorColour)else term.setCursorBlink(false)end;if Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then Current.SelectionDrawTimer=os.startTimer(0.5)end;isDrawing=false;if needsDraw then Draw()end end;function LoadMenuBar()Current.MenuBar=MenuBar:Initialise({Button:Initialise(1,1,nil,nil,colours.grey,Current.MenuBar,function(ad,aB,x,y,aT)if aT then Menu:New(1,2,{{Title="New...",Click=function()DisplayNewDocumentWindow()end,Keys={keys.leftCtrl,keys.n}},{Title='Open...',Click=function()DisplayOpenDocumentWindow()end,Keys={keys.leftCtrl,keys.o}},{Separator=true},{Title='Save...',Click=function()Current.Artboard:Save()end,Keys={keys.leftCtrl,keys.s},Enabled=function()return CheckOpenArtboard()end},{Separator=true},{Title='Quit',Click=function()if Close()then OneOS.Close()end end}},ad,true)else Current.Menu=nil end;return true end,'File',colours.lightGrey,false),Button:Initialise(7,1,nil,nil,colours.grey,Current.MenuBar,function(ad,aB,x,y,aT)if not ad.Toggle then Menu:New(7,2,{{Title='Cut',Click=function()Clipboard.Cut(Current.Layer:PixelsInSelection(true),'sketchpixels')end,Keys={keys.leftCtrl,keys.x},Enabled=function()return Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil end},{Title='Copy',Click=function()Clipboard.Copy(Current.Layer:PixelsInSelection(),'sketchpixels')end,Keys={keys.leftCtrl,keys.c},Enabled=function()return Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil end},{Title='Paste',Click=function()Current.Layer:InsertPixels(Clipboard.Paste())end,Keys={keys.leftCtrl,keys.v},Enabled=function()return not Clipboard.isEmpty()and Clipboard.Type=='sketchpixels'end}},ad,true)else Current.Menu=nil end;return true end,'Edit',colours.lightGrey,false),Button:Initialise(13,1,nil,nil,colours.grey,Current.MenuBar,function(ad,aB,x,y,aT)if aT then Menu:New(13,2,{{Title="Resize...",Click=function()ResizeDocument()end,Keys={keys.leftCtrl,keys.r},Enabled=function()return CheckOpenArtboard()end},{Title="Crop",Click=function()local ax=0;local left=0;local ay=0;local right=0;if Current.Selection[1].x<Current.Selection[2].x then left=Current.Selection[1].x-1;right=Current.Artboard.Width-Current.Selection[2].x else left=Current.Selection[2].x-1;right=Current.Artboard.Width-Current.Selection[1].x end;if Current.Selection[1].y<Current.Selection[2].y then ax=Current.Selection[1].y-1;ay=Current.Artboard.Height-Current.Selection[2].y else ax=Current.Selection[2].y-1;ay=Current.Artboard.Height-Current.Selection[1].y end;Current.Artboard:Resize(-1*ax,-1*ay,-1*left,-1*right)Current.Selection[2]=nil end,Enabled=function()if CheckSelectedLayer()and Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then return true else return false end end},{Separator=true},{Title='New Layer...',Click=function()MakeNewLayer()end,Keys={keys.leftCtrl,keys.l},Enabled=function()return CheckOpenArtboard()end},{Title='Delete Layer',Click=function()DeleteLayer()end,Enabled=function()return CheckSelectedLayer()end},{Title='Rename Layer...',Click=function()RenameLayer()end,Enabled=function()return CheckSelectedLayer()end},{Separator=true},{Title='Erase Selection',Click=function()Current.Layer:EraseSelection()end,Keys={keys.delete},Enabled=function()if CheckSelectedLayer()and Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then return true else return false end end},{Separator=true},{Title='Hide Interface',Click=function()Current.InterfaceVisible=not Current.InterfaceVisible end,Keys={keys.tab}}},ad,true)else Current.Menu=nil end;return true end,'Image',colours.lightGrey,false),Button:Initialise(20,1,nil,nil,colours.grey,Current.MenuBar,function(ad,aB,x,y,aT)if aT then local aJ={{Title="Change Size",Click=function()DisplayToolSizeWindow()end,Keys={keys.leftCtrl,keys.t}},{Separator=true}}local bV={'h','p','e','f','s','m','t'}for W,a9 in ipairs(Tools)do table.insert(aJ,{Title=a9.Name,Click=function()SetTool(a9)local m=ModuleNamed('Tools')m:Update(m.ToolbarItem)end,Keys={keys[bV[W]]},Enabled=function()return CheckOpenArtboard()end})end;Menu:New(20,2,aJ,ad,true)else Current.Menu=nil end;return true end,'Tools',colours.lightGrey,false)})end;function Timer(bW,bX)if bX==Current.ControlPressedTimer then Current.ControlPressedTimer=nil elseif bX==Current.SelectionDrawTimer then if Current.Artboard then Current.Artboard.SelectionIsBlack=not Current.Artboard.SelectionIsBlack;Draw()end end end;function Initialise(bY)if not OneOS then SplashScreen()end;EventRegister('mouse_click',TryClick)EventRegister('mouse_drag',function(bW,aB,x,y)TryClick(bW,aB,x,y,true)end)EventRegister('mouse_scroll',Scroll)EventRegister('key',HandleKey)EventRegister('char',HandleKey)EventRegister('timer',Timer)EventRegister('terminate',function(bW)if Close()then error("Terminated",0)end end)Current.Toolbar=Toolbar:New('right',true)for aP,v in pairs(Modules)do v:Initialise()end;term.setBackgroundColour(UIColours.Background)term.clear()LoadMenuBar()local N=fs;if OneOS then N=OneOS.FS end;if bY and N.exists(bY)then OpenDocument(bY)else DisplayNewDocumentWindow()Current.Window.Visible=false end;ShowInterfaceButton=Button:Initialise(Drawing.Screen.Width-15,1,nil,1,colours.grey,nil,function(ad)Current.InterfaceVisible=true;Draw()end,'Show Interface')Draw()if Current.Window then Current.Window.Visible=true;Draw()end;EventHandler()end;function SplashScreen()local bZ={{1,1,1,256,256,256,256,256,256,256,256,1,1,1},{1,256,256,8,8,8,8,8,8,8,8,256,256,1},{256,8,8,8,8,8,8,8,8,8,8,8,8,256},{256,256,256,8,8,8,8,8,8,8,8,256,256,256},{256,256,256,256,256,256,256,256,256,256,256,256,256,256},{2048,2048,256,256,256,256,256,256,256,256,256,256,2048,2048},{2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048},{2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048},{2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048},{2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048},{256,256,2048,2048,2048,2048,2048,2048,2048,2048,2048,2048,256,256},{1,256,256,256,256,256,256,256,256,256,256,256,256,1},{1,1,1,256,256,256,256,256,256,256,256,1,1,1},["text"]={{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," ","S","k","e","t","c","h"," "," "," "," "},{" "," "," "," "," "," ","b","y"," "," "," "," "," "," "},{" "," "," "," "," ","o","e","e","d"," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "},{" "," "," "," "," "," "," "," "," "," "," "," "," "," "}},["textcol"]={{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,256,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,1,1,1,1,1,1,32768,32768,32768,32768},{32768,32768,32768,32768,8,8,8,8,8,8,8,32768,32768,32768},{32768,32768,32768,32768,1,1,1,1,1,32768,8,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768},{32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768,32768}}}Drawing.Clear(colours.white)Drawing.DrawImage((Drawing.Screen.Width-14)/2,(Drawing.Screen.Height-13)/2,bZ,14,13)Drawing.DrawBuffer()parallel.waitForAny(function()sleep(1)end,function()os.pullEvent('mouse_click')end)end;LongestString=function(b_,key)local c0=0;for W=1,#b_ do local a0=b_[W]if key then if a0[key]then a0=a0[key]else a0=''end end;local c1=string.len(a0)if c1>c0 then c0=c1 end end;return c0 end;function HandleKey(...)local c2={...}local bW=c2[1]local c3=c2[2]if bW=='key'and Current.Tool and Current.Tool.Name=='Text'and Current.Input and c3==keys.up or c3==keys.down or c3==keys.left or c3==keys.right then local c4={Current.CursorPos[1]-Current.Artboard.X+1,Current.CursorPos[2]-Current.Artboard.Y+1}if c3==keys.up then c4[2]=c4[2]-1 elseif c3==keys.down then c4[2]=c4[2]+1 elseif c3==keys.left then c4[1]=c4[1]-1 elseif c3==keys.right then c4[1]=c4[1]+1 end;if c4[1]<1 then c4[1]=1 end;if c4[1]>Current.Artboard.Width then c4[1]=Current.Artboard.Width end;if c4[2]<1 then c4[2]=1 end;if c4[2]>Current.Artboard.Height then c4[2]=Current.Artboard.Height end;Current.Tool:Use(c4[1],c4[2])Current.Modified=true;Draw()elseif Current.Input then if bW=='char'then Current.Input:Char(c3)elseif bW=='key'then Current.Input:Key(c3)end elseif bW=='key'then CheckKeyboardShortcut(c3)end end;function Scroll(bW,c5,x,y)if Current.Window and Current.Window.OpenButton then Current.Window.Scroll=Current.Window.Scroll+c5;if Current.Window.Scroll<0 then Current.Window.Scroll=0 elseif Current.Window.Scroll>Current.Window.MaxScroll then Current.Window.Scroll=Current.Window.MaxScroll end end;Draw()end;function CheckKeyboardShortcut(key)local c6={}if key==keys.leftCtrl then Current.ControlPressedTimer=os.startTimer(0.5)return end;if Current.ControlPressedTimer then c6[keys.n]=function()DisplayNewDocumentWindow()end;c6[keys.o]=function()DisplayOpenDocumentWindow()end;c6[keys.s]=function()Current.Artboard:Save()end;c6[keys.x]=function()if Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then Clipboard.Cut(Current.Layer:PixelsInSelection(true),'sketchpixels')end end;c6[keys.c]=function()if Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then Clipboard.Copy(Current.Layer:PixelsInSelection(),'sketchpixels')end end;c6[keys.v]=function()if not Clipboard.isEmpty()and Clipboard.Type=='sketchpixels'then Current.Layer:InsertPixels(Clipboard.Paste())end end;c6[keys.r]=function()ResizeDocument()end;c6[keys.l]=function()MakeNewLayer()end end;c6[keys.delete]=function()if CheckSelectedLayer()and Current.Selection and Current.Selection[1]and Current.Selection[2]~=nil then Current.Layer:EraseSelection()Draw()end end;c6[keys.backspace]=c6[keys.delete]c6[keys.tab]=function()Current.InterfaceVisible=not Current.InterfaceVisible;Draw()end;c6[keys.h]=function()SetTool(ToolNamed('Hand'))ModuleNamed('Tools'):Update()Draw()end;c6[keys.e]=function()SetTool(ToolNamed('Eraser'))ModuleNamed('Tools'):Update()Draw()end;c6[keys.p]=function()SetTool(ToolNamed('Pencil'))ModuleNamed('Tools'):Update()Draw()end;c6[keys.f]=function()SetTool(ToolNamed('Fill Bucket'))ModuleNamed('Tools'):Update()Draw()end;c6[keys.m]=function()SetTool(ToolNamed('Move'))ModuleNamed('Tools'):Update()Draw()end;c6[keys.s]=function()SetTool(ToolNamed('Select'))ModuleNamed('Tools'):Update()Draw()end;c6[keys.t]=function()SetTool(ToolNamed('Text'))ModuleNamed('Tools'):Update()Draw()end;if c6[key]then c6[key]()return true else return false end end;function CheckClick(aa,x,y)if aa.X<=x and aa.Y<=y and aa.X+aa.Width>x and aa.Y+aa.Height>y then return true end end;function DoClick(aa,aB,x,y,aC)if aa and CheckClick(aa,x,y)then return aa:Click(aB,x-aa.X+1,y-aa.Y+1,aC)end end;function TryClick(bW,aB,x,y,aC)if Current.InterfaceVisible and Current.Menu then if DoClick(Current.Menu,aB,x,y,aC)then Draw()return else if Current.Menu.Owner and Current.Menu.Owner.Toggle then Current.Menu.Owner.Toggle=false end;Current.Menu=nil;Draw()return end elseif Current.Window then if DoClick(Current.Window,aB,x,y,aC)then Draw()return else Current.Window:Flash()return end end;local c7={}if Current.InterfaceVisible then table.insert(c7,Current.MenuBar)else table.insert(c7,ShowInterfaceButton)end;for W,v in ipairs(Lists.Interface.Toolbars)do for W,c8 in ipairs(v.ToolbarItems)do table.insert(c7,c8)end;table.insert(c7,v)end;table.insert(c7,Current.Artboard)for W,aa in ipairs(c7)do if DoClick(aa,aB,x,y,aC)then Draw()return end end;Draw()end;function EventRegister(bW,c9)if not Events[bW]then Events[bW]={}end;table.insert(Events[bW],c9)end;function EventHandler()while true do local bW,ca,cb,cc,cd=os.pullEventRaw()if Events[bW]then for W,e in ipairs(Events[bW])do e(bW,ca,cb,cc,cd)end end end end;local ce={[10]="a",[11]="b",[12]="c",[13]="d",[14]="e",[15]="f"}local function cf(C)if C==colours.transparent or not C or not tonumber(C)then return" "end;local a0=math.log(C)/math.log(2)if a0>9 then a0=ce[a0]end;return a0 end;local function cg(_)if _==' 'then return colours.transparent end;local a0=tonumber(_,16)if not a0 then return nil end;a0=math.pow(2,a0)return a0 end;function SaveSKCH()local aw={}for W,l in ipairs(Current.Artboard.Layers)do local aj=SaveNFT(W)local af={Name=l.Name,Pixels=aj,BackgroundColour=l.BackgroundColour,Visible=l.Visible,Index=l.Index}table.insert(aw,af)end;return aw end;function SaveNFT(af)af=af or 1;local az={}local at=Current.Artboard.Width;local au=Current.Artboard.Height;for y=1,au do local aA=''local ch=nil;local ci=nil;for x=1,at do local a3=Current.Artboard.Layers[af].Pixels[x][y]if a3.BackgroundColour~=ch then aA=aA..string.char(30)..cf(a3.BackgroundColour)ch=a3.BackgroundColour end;if a3.TextColour~=ci then aA=aA..string.char(31)..cf(a3.TextColour)ci=a3.TextColour end;aA=aA..a3.Character end;table.insert(az,aA)end;return az end;function SaveNFP()local az={}local at=Current.Artboard.Width;local au=Current.Artboard.Height;for y=1,au do local aA=''for x=1,at do aA=aA..cf(Current.Artboard.Layers[1].Pixels[x][y].BackgroundColour)end;table.insert(az,aA)end;return az end;function ReadNFP(L)local aj={}local N=fs;if OneOS then N=OneOS.FS end;local P=N.open(L,'r')local aA=P.readLine()local y=1;while aA do for x=1,#aA do if not aj[x]then aj[x]={}end;aj[x][y]={BackgroundColour=cg(aA:sub(x,x))}end;y=y+1;aA=P.readLine()end;P.close()return{{Pixels=aj}}end;function ReadNFT(L)local N=fs;if OneOS then N=OneOS.FS end;local P=N.open(L,'r')local aA=P.readLine()local az={}while aA do table.insert(az,aA)aA=P.readLine()end;P.close()return{{Pixels=ParseNFT(az)}}end;function ParseNFT(az)local aj={}for y,aA in ipairs(az)do local S,T=false,false;local U,V=nil,nil;local cj=1;for x=1,#aA do if not aj[cj]then aj[cj]={}end;local Z=string.sub(aA,x,x)if Z:byte()==30 then S=true elseif Z:byte()==31 then T=true elseif S then U=cg(Z)if U==nil then U=colours.transparent end;S=false elseif T then V=cg(Z)T=false else if Z~=" "and V==nil then V=colours.white end;aj[cj][y]={BackgroundColour=U,TextColour=V,Character=Z}cj=cj+1 end end end;return aj end;function ReadSKCH(L)local N=fs;if OneOS then N=OneOS.FS end;local P=N.open(L,'r')local ck=textutils.unserialize(P.readAll())P.close()local aw={}for W,l in ipairs(ck)do local af={Name=l.Name,Pixels=ParseNFT(l.Pixels),BackgroundColour=l.BackgroundColour,Visible=l.Visible,Index=l.Index}table.insert(aw,af)end;return aw end;if term.isColor and term.isColor()then Initialise(...)else print('Sorry, but Sketch only works on Advanced (gold) Computers')end