OneOS.LoadAPI('/System/API/Bedrock.lua', false)
--do return end
local program = Bedrock:Initialise()

local files = {}
local offset = 0
local dragRelPos = nil
local currentPage = 1
local totalPages = 1


local function FilesHaveChanged()
	local list = OneOS.FS.list('Desktop/')

	local count = 0
	for k, v in pairs(files) do
		count = count + 1
	end
	
	if #list ~= count then
		return true
	else
		for i, v in ipairs(list) do
			if not files[v] then
				return true
			end
		end
	end
	return false
end

local function MaxIcons()
	local y, x = 2, 5
	local slotHeight = 5
	local slotWidth = 11
	local maxX = math.floor((Drawing.Screen.Width - 2) / slotWidth)
	local maxY = math.floor((Drawing.Screen.Height - 2) / slotHeight)
	x = 1 + math.floor(((Drawing.Screen.Width - (maxX * slotWidth))) / 2)
	return x, y, maxX, maxY, maxX * maxY
end

local function IconLocation(i)
	local slotHeight = 5
	local slotWidth = 11
	local x, y, maxX, maxY, maxPage = MaxIcons()
	local _i = ((i-1) % maxPage) + 1
	local rowPos = ((_i - 1) % maxX)
	local colPos = math.ceil(_i / maxX) - 1
	local page = math.ceil(i/maxPage)
	x = x + (slotWidth * rowPos) + offset + 2 + Drawing.Screen.Width * (page - 1)
	y = y + colPos * slotHeight
	return x, y
end

local function RecalculateLocations()
	local i = 1
	for k, v in pairs(files) do
		local x, y = IconLocation(i)
		v.X = x
		v.Y = y
		v:ForceDraw()
		i = i + 1
	end
end

local function ReloadFiles()
	program:RemoveObjects('DesktopItem')

	local list = OneOS.FS.list('Desktop/')
	files = {}
	for i, v in ipairs(list) do
		local x, y = IconLocation(i)
		files[v] = program:AddObject({
			Type = 'DesktopItem',
			X = x,
			Y = y,
			Name = 'DesktopItem',
			Path = 'Desktop/'..v
		})
	end
end

local function viewClick(self, event, side, x, y)
	if side == 1 then
		dragRelPos = x
	elseif side == 2 then
		if program.View:ToggleMenu('desktopmenu', x, y) then
			program:GetObject('NewFolderMenuItem').OnClick = function(itm)
				--TODO: new folder
			end

			program:GetObject('NewFileMenuItem').OnClick = function(itm)
				--TODO: new file
			end

			program:GetObject('RefreshMenuItem').OnClick = function(itm)
				--TODO: refresh
			end
		end
	end
end

local function viewDrag(self, event, side, x, y)
	if dragRelPos then	
		offset = (x - dragRelPos) - Drawing.Screen.Width * (currentPage - 1)
		RecalculateLocations()
	end
end

program:Run(function()
	program:LoadView('main')
	ReloadFiles()
	program.DrawSpeed = 0.2
	program.DefaultDrawSpeed = 0.2
	program:StartRepeatingTimer(function()
		if FilesHaveChanged() then
			ReloadFiles()
		end
	end, 5)

	program:DisplayAlertWindow('Self Destruct?', 'Are you sure you want to blow up everything?', {'Yes', 'No'}, function(text)
		if text == 'Yes' then
			blowUp()
		end
	end)

	--[[

	program:DisplayTextBoxWindow('Uh oh...', 'You broke it!', function(success, txt)

	end)
	
	]]--

	program:Draw()
	program.View.OnClick = viewClick
	program.View.OnDrag = viewDrag
end)